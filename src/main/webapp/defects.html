<div ng-controller="DefectController">
    <div class="page-header">
        <h1>
            <msg key="defects" />
        </h1>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered">
            <tr>
                <th><msg key="bundleId" /></th>
            <th><msg key="specId" /></th>
            <th><msg key="madeOn" /></th>
            <th><msg key="operator" /></th>
            <th class="info"><msg key="bundleWidth" />(mm)</th>
            <th class="info"><msg key="len" />(m)</th>
            <th class="danger"><msg key="defectNum" /></th>
            <th class="danger"><msg key="score" /></th>
            <th class="success"><msg key="grade" /></th>
            </tr>
            <tr>
                <td>{{stat.bundleId}}</td>
                <td>{{stat.specId}}</td>
                <td>{{stat.startTime|date:'yyyy/MM/dd'}}</td>
                <td>{{stat.operator}}</td>
                <td class="info">{{stat.maxWidth}}</td>
                <td class="info">{{stat.checkLen|number:2}}</td>
                <td class="danger">{{stat.defectNum}}</td>
                <td class="danger">{{stat.score}}</td>
                <td class="success">{{gnames[stat.grade]}}</td>
            </tr>
        </table>
    </div>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs nav-justified">
        <li ng-class="{active:tabIsSelected('listView')}"><a ng-click="selectTab('listView')" data-toggle="tab"><msg key="listView"/></a></li>
        <li ng-class="{active:tabIsSelected('imgView')}" ng-click="initImg()"><a ng-click="selectTab('imgView')" data-toggle="tab"><msg key="imgView"/></a></li>
        <li ng-class="{active:tabIsSelected('plotView')}" ng-click="initScatter()"><a ng-click="selectTab('plotView')" data-toggle="tab"><msg key="plotView"></msg></a></li>
        <li ng-class="{active:tabIsSelected('imgPlotView')}" ng-click="initImgPlotView()"><a ng-click="selectTab('imgPlotView')" data-toggle="tab"><msg key="imgPlotView"></msg></a></li>
        <li ng-class="{active:tabIsSelected('areaPlotView')}" ng-click="initAreaPlotView()"><a ng-click="selectTab('areaPlotView')" data-toggle="tab"><msg key="areaPlotView"></msg></a></li>
        <li ng-class="{active:tabIsSelected('defectStatView')}" ng-click="initRangeStat()"><a ng-click="selectTab('defectStatView')" data-toggle="tab"><msg key="defectStatView"></msg></a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div ng-class="{active:tabIsSelected('listView')}" class="tab-pane" id="listView">
            <div class="row">
                <div class="col-md-9">
                    <div class="row toolbar">
                        <div class="pull-right">
                            <button type="button" class="btn btn-success" ng-click="exportDefects()"> <msg key="exportAsXls"></msg></button>
                        </div>
                    </div>

                    <div class="table-responsive" ng-show="result">
                        <table class="table table-striped">
                            <tr>
                                <th>#</th>
                                <th><msg key="type"></msg></th>
                            <th><msg key="physicalX"></msg>(mm)</th>
                            <th><msg key="physicalY"></msg>(m)</th>
                            <th>-<msg key="physicalX"></msg>(mm)</th>
                            <th>-<msg key="physicalY"></msg>(m)</th>
                            <th><msg key="physicalWidth"></msg>(mm)</th>
                            <th><msg key="physicalLength"></msg>(mm)</th>
                            <th><msg key="area"></msg>(mm<sup>2</sup>)</th>
                            <th><msg key="actions"></msg></th>
                            </tr>
                            <tr ng-repeat="defect in result.content" ng-class="{success:rowIsSelected($index)}" ng-click="selectRow($index)">
                                <td>{{defect.id}}</td>
                                <td><msg key-expr="'type'+defect.type"/></td>
                            <td>{{defect.physicalX - stat.leftEdge|number:2}}</td>
                            <td>{{defect.physicalY|number:2}}</td>
                            <td>{{stat.maxWidth - defect.physicalX - stat.leftEdge|number:2}}</td>
                            <td>{{stat.checkLen - defect.physicalY|number:2}}</td>
                            <td>{{defect.physicalWidth|number:2}}</td>
                            <td>{{defect.physicalLength|number:2}}</td>
                            <td>{{defect.area|number:2}}</td>
                            <td> <a ng-show="user.username && (user.role == 'ADMIN' || user.role == 'ENGINEER')" ng-click="initEdit($index);
                                        $event.stopPropagation();"><span class="glyphicon glyphicon-pencil"></span></a>
                                <a ng-show="user.username && user.role == 'ADMIN'"  ng-click="delete($index);
                                            $event.stopPropagation();"><span
                                        class="glyphicon glyphicon-trash"></span></a></td>
                            </tr>
                        </table>
                    </div>
                    <div class="row" ng-show="result">
                        <div class="col-md-4 pagination">
                            <div class="btn-toolbar pull-right" role="toolbar">
                                <div class="btn-group  btn-group-sm">
                                    <div class="btn btn-default"><msg key="totalPages"/>{{result.totalPages}}</div>
                                    <div class="btn btn-default"><msg key="totalItems"/>{{result.totalElements}}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <ul class="pagination pagination-sm">
                                <li ng-class="{disabled:!!result.firstPage}"><a ng-click="selectPage(0)">&laquo;</a></li>
                                <li ng-class="{disabled:!result.hasPreviousPage}"><a ng-click="prePage()">&lsaquo;</a></li>
                                <li ng-class="{active:page == p}" ng-repeat="p in displayPages"><a ng-click="selectPage(p)">{{p + 1}}</a></li>
                                <li ng-class="{disabled:!result.hasNextPage}"><a ng-click="nextPage()">&rsaquo;</a></li>
                                <li ng-class="{disabled:!!result.lastPage}"><a ng-click="selectPage(result.totalPages - 1)">&raquo;</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="row">
                        <a ng-click="showPreviewImg()"><img ng-src="{{imgPreviewSrc}}"/></a></div>
                    <div class="row">
                        <table class="table table-bordered">
                            <tr>
                                <th><msg key="type"/></th>
                            <th><msg key="numbers"/></th>
                            <th><msg key="ratios"/></th>
                            </tr>
                            <tr ng-repeat="n in numbers">
                                <td><msg key-expr="'type'+n.type"/></td>
                            <td>{{n.num}}</td>
                            <td>{{n.ratio|number:2}}%</td>
                            </tr>
                        </table>         
                    </div>
                </div>
            </div> 
        </div>
        <div ng-class="{active:tabIsSelected('imgView')}" class="tab-pane" id="imgView">
            <div class="row toolbar">
                <div class="pull-right">
                    <button type="button" class="btn btn-success" ng-click="exportDefectImgXls()"> <msg key="exportAsPdf"></msg></button>
                </div>
            </div>
            <div ng-include="'inc/imgview.html'"></div>
        </div>
        <div ng-class="{active:tabIsSelected('plotView')}" class="tab-pane" id="plotView">
            <div ng-include="'inc/plotview.html'"></div>

        </div>

        <div ng-class="{active:tabIsSelected('imgPlotView')}" class="tab-pane" id="imgPlotView">
            <div class="row">         
                <div class="col-md-4">
                    <div ng-include="'inc/plotview.html'"></div>
                </div>
                <div class="col-md-8">
                    <div ng-include="'inc/imgview.html'"></div>
                </div>
            </div>
        </div>

        <div ng-class="{active:tabIsSelected('areaPlotView')}" class="tab-pane" id="areaPlotView">
            <div ng-include="'inc/areaplotview.html'"></div>
        </div>
        <div ng-class="{active:tabIsSelected('defectStatView')}" class="tab-pane" id="defectStatView">
            <div class="row toolbar">
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group btn-group-sm">
                        <div class=" btn btn-default"><msg key="xdir"/></div>
                        <button type="button" class="btn" ng-class="{'btn-primary':rangeIsSelected('x',10), 'btn-default':!rangeIsSelected('x',10)}" ng-click="selectRange('x', 10)"><msg key="x10"/></button>
                        <button type="button" class="btn" ng-class="{'btn-primary':rangeIsSelected('x',50), 'btn-default':!rangeIsSelected('x',50)}" ng-click="selectRange('x', 50)"><msg key="x50"/></button>
                        <button type="button" class="btn" ng-class="{'btn-primary':rangeIsSelected('x',100), 'btn-default':!rangeIsSelected('x',100)}" ng-click="selectRange('x', 100)"><msg key="x100"/></button>
                    </div>

                    <div class="btn-group btn-group-sm">
                        <div class=" btn btn-default"><msg key="ydir"/></div>
                        <button type="button" class="btn" ng-class="{'btn-primary':rangeIsSelected('y',10), 'btn-default':!rangeIsSelected('y',10)}" ng-click="selectRange('y', 10)"><msg key="y10"/></button>
                        <button type="button" class="btn" ng-class="{'btn-primary':rangeIsSelected('y',50), 'btn-default':!rangeIsSelected('y',50)}" ng-click="selectRange('y', 50)"><msg key="y50"/></button>
                        <button type="button" class="btn" ng-class="{'btn-primary':rangeIsSelected('y',100), 'btn-default':!rangeIsSelected('y',100)}" ng-click="selectRange('y', 100)"><msg key="y100"/></button>
                    </div>

                    <div class="btn-group pull-right">
                        <button type="button" class="btn btn-success" ng-click="exportRangeStat()" ><msg key="exportAsXls"/></button>
                    </div>
                </div> 
            </div>
            <div class="row">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tr>
                            <th></th>
                            <th ng-repeat="type in ltypes"><msg key-expr="'type'+type"/></th>

                        <th><msg key="sum"/></th>
                        <th><msg key="score"/></th>
                        <th><msg key="grade"/></th>
                        </tr>
                        <tr ng-repeat="item in rangeStat">
                            <td>{{($index + 1) * rangeStep}}</td>
                            <td ng-repeat="defcnt in item.cnt track by $index">{{defcnt>0?defcnt:''}}</td>

                            <td>{{item.sum}}</td>
                            <td>{{item.score}}</td>
                            <td>{{item.grade}}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel"><msg key="imagePreview"></msg></h4>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="img-responsive">
                            <img ng-src="{{imgData}}"/>                        
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="defectDialog" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form class="form form-horizontal" role="form" ng-submit="save()">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"
                                aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">
                            <msg key="editDefect"></msg>
                        </h4>
                    </div>
                    <div class="modal-body">

                        <div class="row">

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label  col-md-4"><msg key="physicalX"></msg></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" placeholder="physicalX"
                                               ng-model="defect.physicalX"></input>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-4"><msg key="physicalY"></msg></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" placeholder="physicalY"
                                               ng-model="defect.physicalY"></input>
                                    </div>
                                </div>
                            </div>                       
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label  col-md-4"><msg key="physicalWidth"></msg></label>
                                    <div class="col-md-8">
                                        <input class="form-control" type="text" placeholder="physicalWidth"
                                               ng-model="defect.physicalWidth"></input>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label  col-md-4"><msg key="physicalLength"></msg></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" placeholder="physicalLength"
                                               ng-model="defect.physicalLength"></input>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-4"><msg key="physicalHeight"></msg></label>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" placeholder="physicalHeight"
                                               ng-model="defect.physicalHeight"></input>
                                    </div>
                                </div>
                            </div>                       
                        </div>


                        <div class="row">

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-4"><msg key="type"></msg></label>                          
                                    <div class="col-md-8">
                                        <input class="form-control col-md-5" type="text"
                                               ng-model="defect.type"></input>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label col-md-4"><msg
                                            key="area"></msg></label>
                                    <div class="col-md-8">
                                        <input class="form-control col-md-5" type="text"
                                               placeholder="area" ng-model="defect.area"></input>
                                    </div>
                                </div>
                            </div>

                        </div>


                    </div>
                    <div class="modal-footer">
                        <button type="button" ng-click="save()" class="btn btn-primary">
                            <msg key="save"></msg>
                        </button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">
                            <msg key="cancel"></msg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <a id="dl-link"></a>
</div>